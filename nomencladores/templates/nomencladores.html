{% extends 'base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block style %}
        <!-- Google Font: Source Sans Pro -->
        <link rel="stylesheet"
              href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="{% static 'css/fontawesome-free/css/all.min.css' %}">
        <link rel="stylesheet" href="{% static 'css/estilos.css' %}">

        <!-- Select -->
        <link rel="stylesheet" href="{% static 'select2/css/select2.min.css' %}">
        <link rel="stylesheet" href="{% static 'select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">

    {% endblock %}
    <!-- Theme style -->
    <link rel="stylesheet" href="{% static 'css/adminlte.min.css' %}">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- Navbar -->

    <!-- /.navbar -->

    <!-- Main Sidebar Container -->

    <!-- /.sidebar -->
    </aside>
    <div class="content-wrapper" id="wrapper">
        <!-- Content Header (Page header) -->
        <!-- Main content -->
        <section class="content">
            {% block body %}
            <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">

          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- SELECT2 EXAMPLE -->
        <div class="card card-default">
          <div class="card-header">
            <h3 class="card-title">Configurar Nomencladores</h3>

            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>
              <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                <form method="post" name="action" id="add_direcciones">{% csrf_token %}
                  <label>Direcciones</label>
                  <select class="form-control select2" style="width: 100%;" id="direcciones">
                    {% for direcciones in list_direcciones %}
                    <option value="{{ direcciones.pk }}"{% if direcciones.id == id %} selected="selected"{% endif %}>{{ direcciones }}
                    </option>
                   {% endfor %}
                  </select>
                    <div class="d-flex justify-content-end">
                        <button class="mt-2 btn-outline-success" type="submit">Agregar</button>
                        <button class="mt-2 ml-2 btn-outline-dark">Editar</button>
                        <button class="mt-2 ml-2 btn-outline-danger">Eliminar</button>
                    </div>
                </form>

                </div>
                <!-- /.form-group -->
                  <div class="form-group">
                  <form method="post" name="action" id="add_provincias">
                  <label>Provincias</label>
                  <select class="form-control select2" style="width: 100%;" id="provincia">
                       {% for provincia in list_provincia %}
                    <option value="{{ provincia.pk }}"{% if provincia.id == id %} selected="selected"{% endif %}>{{ provincia }}
                    </option>
                   {% endfor %}
                  </select>
                    <div class="d-flex justify-content-end">
                        <button class="mt-2 btn-outline-success">Agregar</button>
                        <button class="mt-2 ml-2 btn-outline-dark">Editar</button>
                        <button class="mt-2 ml-2 btn-outline-danger">Eliminar</button>
                    </div>

                </div>
                  <div class="form-group">
                  <label>Tipo de documento de entrada</label>
                  <select class="form-control select2" style="width: 100%;">
                   {% for tdoc in list_t_documento %}
                       <option value="{{ tdoc.pk }}"{% if tdoc.id == id %} selected="selected"{% endif %}>{{ tdoc }}
                       </option>
                   {% endfor %}
                  </select>
                    <div class="d-flex justify-content-end">
                        <button class="mt-2 btn-outline-success">Agregar</button>
                        <button class="mt-2 ml-2 btn-outline-dark">Editar</button>
                        <button class="mt-2 ml-2 btn-outline-danger">Eliminar</button>
                    </div>

                </div>

                <!-- /.form-group -->
              </div>
              <!-- /.col -->
              <div class="col-md-6">
                <div class="form-group">

                  <label>Organismo</label>
                  <select class="form-control select2" style="width: 100%;">
                    {% for organismo in list_organismo %}
                      <option value="{{ organismo.pk }}"{% if organismo.id == id %} selected="selected"{% endif %}>{{ organismo }}
                      </option>
                   {% endfor %}
                  </select>
                    <div class="d-flex justify-content-end">
                        <button class="mt-2 btn-outline-success">Agregar</button>
                        <button class="mt-2 ml-2 btn-outline-dark">Editar</button>
                        <button class="mt-2 ml-2 btn-outline-danger">Eliminar</button>
                    </div>

                </div>
                <!-- /.form-group -->
                <div class="form-group">
                  <label>Entidad</label>
                  <select class="form-control select2" style="width: 100%;">
                     {% for entidades in list_entidad %}
                       <option value="{{ entidades.pk }}"{% if entidades.id == id %} selected="selected"{% endif %}>{{ entidades }}
                       </option>
                     {% endfor %}
                  </select>
                    <div class="d-flex justify-content-end">
                        <button class="mt-2 btn-outline-success">Agregar</button>
                        <button class="mt-2 ml-2 btn-outline-dark">Editar</button>
                        <button class="mt-2 ml-2 btn-outline-danger">Eliminar</button>
                    </div>

                </div>
              <div class="form-group">
                  <label>Tipo de documento de salida</label>
                  <select class="form-control select2" style="width: 100%;">
                    {% for tdoc_sal in list_t_documento_salida %}
                       <option value="{{ tdoc_sal.pk }}"{% if tdoc_sal.id == id %} selected="selected"{% endif %}>{{ tdoc_sal }}
                       </option>
                    {% endfor %}
                  </select>
                    <div class="d-flex justify-content-end">
                        <button class="mt-2 btn-outline-success">Agregar</button>
                        <button class="mt-2 ml-2 btn-outline-dark">Editar</button>
                        <button class="mt-2 ml-2 btn-outline-danger">Eliminar</button>
                    </div>

                </div>
                <!-- /.form-group -->
              </div>
              <!-- /.col -->

            </div>
          </div>
        </div>
      </div>
    </section>

            <!-- /.row -->

{% endblock body %}

    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>

</div>11
{% block script %}
    <!-- jQuery -->
   <script src="{% static 'js/jquery/jquery.min.js' %}"></script>
    <!-- Bootstrap 4 -->
    <script src="{% static 'js/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/entradas.js' %}"></script>
    <!-- DataTables  & Plugins -->



<script>

        //Capturar el valor del csrf
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

      /****Capturando valores por el id para agregar Entidad****/
        d = document;
        const nombre = d.getElementById("id_nombre");
     /****Capturando valores por el id para agregar Provincia****/
        d = document;
        const direcciones = d.getElementById("direcciones");
        const provincias = d.getElementById("provincias");
        const organismo = d.getElementById("direcciones");
        const entidad = d.getElementById("direcciones");
        const tipo_doc_salida = d.getElementById("direcciones");
        const tipo_doc = d.getElementById("direcciones");
        console.log(direcciones);


        /****Capturando id para pasarle valores para el form editar****/

        const input_no_salida = d.getElementById("id_edit_no_salida_doc");
        const input_titulo = d.getElementById("id_edit_titulo");
        const input_f_salida = d.getElementById("id_edit_f_salida_doc");
        const input_procedencia = d.getElementById("id_edit_procedencia");
        const input_organismo = d.getElementById("id_edit_organismo");
        const input_entidad = d.getElementById("id_edit_entidad");
        const input_t_documento_salida = d.getElementById("id_edit_t_documento_salida");
        const input_observaciones = d.getElementById("id_edit_observaciones");
        const input_forma_salida_doc = d.getElementById("id_edit_forma_salida");
        const input_soporte_doc_salida = d.getElementById("id_edit_soporte_salida");
        const input_provincia = d.getElementById("id_edit_provincia");


        const EnviarForm = () => {
            d.addEventListener("submit", ev => {
                ev.preventDefault();
                /****Capturando valores para el envio del formulario de agregar documento****/
                var fd_add;
                fd_add = new FormData;
                fd_add.append('ccsrfmiddlewaretoken', getCookie("csrftoken"));
                fd_add.append('nombre', nombre.value);
                fd_add.append('action', entidad_action.value);

                if (last >= no_salida_doc.value) {
                    Swal.fire(
                          'Error!',
                          'Existe un error en el número de entrada',
                          'error'
                        )
                } else if (last + 1 < no_salida_doc.value) {
                     Swal.fire(
                          'Error!',
                          'Existe un error en el número de entrada',
                          'error'
                        )
                } else {
                    const request = new Request(
                        {% url 'agregar_nomencladores' %},
                        {
                            headers: {'X-CSRFToken': getCookie("csrftoken")},
                            'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
                            'Content-Type': 'x-www-form-urlencoded'
                        }
                    );
                    fetch(request, {
                        method: 'post',
                        mode: 'same-origin',
                        body: fd_add,

                    })
                        .then(response => response.json())
                        .then(data => {
                            Swal.fire({
                              icon: 'success',
                              title: 'Documento guardado exitosamente',
                              showConfirmButton: true,
                        }).then(function () {
                            location.reload()
                            })
                        })
                        .catch((error) => {
                            console.log(error);
                            Swal.fire({
                              icon: 'error',
                              title: 'Oops...',
                              text: 'Algo salió mal!',
                              footer: error
                                })
                        });
                }
            });
        };


        const handleEdit = () => {
            d.addEventListener("click", ev => {
                let fn;
                if (ev.target.matches(".btn-floating .fa-edit ")) {
                    const $btn_edit = ev.target,
                        $alltr = $btn_edit.closest('tr'),
                        todos = $alltr.querySelectorAll('td');
                    fn = new FormData;
                    fn.append('ccsrfmiddlewaretoken', getCookie("csrftoken"));
                    fn.append('salida', todos[0].innerText);
                    const request = new Request(
                        {% url 'editar_salidas' %},
                        {
                            headers: {'X-CSRFToken': getCookie("csrftoken")},
                            'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
                            'Content-Type': 'x-www-form-urlencoded'
                        }
                    );
                    fetch(request, {
                        method: 'POST',
                        mode: 'same-origin',
                        body: fn,

                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            input_no_salida.value = data['no_salida_doc'];
                            input_titulo.value = data['titulo'];
                            input_f_salida.value = data['f_salida_doc'];
                            input_provincia.value = data['provincia'];
                            input_organismo.value = data['organismo'];
                            input_entidad.value = data['entidad'];
                            input_t_documento_salida.value = data['tipo_documento_salida'];
                            input_observaciones.value = data['observaciones'];
                            input_forma_salida_doc.value = data['forma_salida'];
                            input_procedencia.value = data['procedencia'];
                            input_soporte_doc_salida.value = data['soporte_salida'];
                        })
                        .catch((error) => {
                            console.log(error);
                            swal.fire({
                              icon: 'error',
                              title: 'Oops...',
                              text: 'Algo salió mal!',
                              footer: error
                                })

                         })

              }  });
        };

        const handleSubmitEdit = () => {
            d.addEventListener("click", ev => {
                if(ev.target.matches(".btn-outline-success")){
                    let fd_edit;
                    fd_edit = new FormData;
                    fd_edit.append('ccsrfmiddlewaretoken', getCookie("csrftoken"));
                    fd_edit.append('titulo', input_titulo.value);
                    fd_edit.append('no_salida_doc', input_no_salida.value);
                    fd_edit.append('f_salida_doc', input_f_salida.value);
                    fd_edit.append('procedencia', input_procedencia.value);
                    fd_edit.append('organismo', input_organismo.value);
                    fd_edit.append('entidad', input_entidad.value);
                    fd_edit.append('tipo_documento_salida', input_t_documento_salida.value);
                    fd_edit.append('observaciones', input_observaciones.value);
                    fd_edit.append('forma_salida', input_forma_salida_doc.value);
                    fd_edit.append('soporte_salida', input_soporte_doc_salida.value);
                    fd_edit.append('provincia', input_provincia.value);

                    const request = new Request(
                        {% url 'editar_salidas' %},
                        {
                            headers: {'X-CSRFToken': getCookie("csrftoken")},
                            'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
                            'Content-Type': 'x-www-form-urlencoded'
                        }
                    );
                    fetch(request, {
                        method: 'post',
                        mode: 'same-origin',
                        body: fd_edit,

                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            Swal.fire({
                              icon: 'success',
                              title: 'Documento editado exitosamente',
                              showConfirmButton: true,
                        }).then(function () {
                            location.reload()
                            });


                        })
                        .catch((error) => {
                            console.log(error);
                            swal.fire({
                              icon: 'error',
                              title: 'Oops...',
                              text: 'Algo salió mal!',
                              footer: error
                                })
                        });
                }

            });

        }



        const handleDelete = () =>{
            d.addEventListener("click", ev => {
                let fd;
                if(ev.target.matches(".btn-outline-danger ") || (ev.target.matches(".fa-trash"))){
                    Swal.fire({
                      title: 'Desea eliminar el documento?',
                      text: "Si acepta no se podrá revertir el proceso",
                      icon: 'warning',
                      showCancelButton: true,
                      confirmButtonColor: '#3085d6',
                      cancelButtonColor: '#d33',
                      confirmButtonText: 'Si, elimínalo!',
                      cancelButtonText: "Cancelar",
                    }).then((result) => {
                      if (result.isConfirmed) {
                          const $btn_delete = ev.target,
                            $alltr = $btn_delete.closest('tr'),
                            todos = $alltr.querySelectorAll('td');

                           fd = new FormData;
                           fd.append('ccsrfmiddlewaretoken', getCookie("csrftoken"));
                           fd.append('salida', todos[0].innerText);
                            const request = new Request(
                                {% url 'eliminar_salidas' %},
                                {
                                    headers: {'X-CSRFToken': getCookie("csrftoken")},
                                    'Accept': 'application/json, application/xml, text/plain, text/html, *.*',
                                    'Content-Type': 'x-www-form-urlencoded'
                                }
                            );
                            fetch(request, {
                                method: 'POST',
                                mode: 'same-origin',
                                body: fd,

                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data);
                                    Swal.fire({
                                       icon: 'success',
                                       title: 'Documento eliminado exitosamente',
                                       showConfirmButton: true,
                                        }).then(function () {
                                         location.reload()
                                        });

                                })
                                .catch((error) => {
                                    console.log(error);
                                    swal.fire({
                                      icon: 'error',
                                      title: 'Oops...',
                                      text: 'Algo salió mal!',
                                      footer: error
                                })
                                });

                      }
                    })

                }
            })
        };


        d.addEventListener("DOMContentLoaded", () => {

            EnviarForm();
            handleEdit();
            handleSubmitEdit();
            handleDelete()
        });
    </script>
{% endblock %}
</body>
</html>